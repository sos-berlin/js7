#!/usr/bin/env bash
set -euo pipefail

JOBSCHEDULER_HOME="$(cd "${0%/*}/../bin/.." && pwd)"
export JOBSCHEDULER_HOME
. "$JOBSCHEDULER_HOME/bin/internal/set-context.sh"
declare classpathString java  # returned by set-context.sh

config=/var/opt/js7/agent/config
data=/var/opt/js7/agent/data
httpPort=127.0.0.1:4444
httpsPort=4443
agentOptions=()
javaOptions=(
  -XX:+UseStringDeduplication
  -XX:MaxJavaStackTraceDepth=999999999)
log4Async=false
terminateCommand='{ "TYPE": "ShutDown" }'

for arg in "$@"; do
  case "$arg" in
    --rmx-port=*)
      a="${arg#*=}"
      javaOptions+=(
        "-Dcom.sun.management.jmxremote"
        "-Dcom.sun.management.jmxremote.ssl=false"
        "-Dcom.sun.management.jmxremote.authenticate=false"
        "-Dcom.sun.management.jmxremote.port=$a")
      ;;
    --debug-port=*)
      a="${arg#*=}"
      javaOptions+=("-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=$a")
      ;;
    --java-option=*)
      a="${arg#*=}"
      javaOptions+=("$a")
      ;;
    -J*)
      a="${arg#-J}"
      javaOptions+=("$a")
      ;;
    --directory=*)
      config="${arg#*=}"/config
      data="${arg#*=}"/data
      ;;
    --config-directory=*)
      config="${arg#*=}"
      ;;
    --data-directory=*)
      data="${arg#*=}"
      ;;
    --http-port=*)
      httpPort="${arg#*=}"
      ;;
    --https-port=*)
      httpsPort="${arg#*=}"
      ;;
    --log4j-async)
      log4Async=true
      ;;
    *)
      agentOptions+=("$arg")
      ;;
  esac
done

if [ ! -d "$config" ]; then :
  echo "No such directory: --config-directory=$config"
  exit 1
fi
config="$(toSystemPath "$config")"

if [ ! -d "$data" ]; then :
  echo "No such directory: --data-directory=$data"
  exit 1
fi
data="$(toSystemPath "$data")"

logs="$data/logs"
[ -d "$logs" ] || mkdir "$logs"

stateDir="$data/state"
[ -d "$stateDir" ] || mkdir "$stateDir"

exec > >(tee -a "$logs"/stdouterr.log) 2>&1  # Redirects stderr to stdout as a side effect
javaOptions+=("-Djs7.log4j.directory=$logs")  # Used in logging configuration
if [ -f "$config/log4j2.xml" ]; then :
  javaOptions+=("-Dlog4j.configurationFile=$config/log4j2.xml")
fi
if $log4Async; then :
  javaOptions+=("-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector")
  javaOptions+=("-Dlog4j2.asyncLoggerWaitStrategy=Block")  # Uses less CPU when idling than default "Timeout"
  javaOptions+=("-Djs7.log4j.immediateFlush=false")
fi

agentOptions+=("--config-directory=$config")
agentOptions+=("--data-directory=$data")
[ -z "$httpPort" ] || agentOptions+=("--http-port=$httpPort")
[ -z "$httpsPort" ] || agentOptions+=("--https-port=$httpsPort")

crashKillScript=$([ -n "$data" ] && echo "$data/kill_tasks_after_crash.sh")
echo "crashKillScript=$crashKillScript"
[ -z "$crashKillScript" ] || rm -f "$crashKillScript"

execute=(
  "$java"
  "${javaOptions[@]}"
  -classpath "$classpathString"
  js7.agent.main.AgentMain
  "${agentOptions[@]}")

while true; do
  rm -rf "$data"/tmp

  (t=$(date +"%Y-%m-%d %H:%M:%S.%N"); echo -e "\n-------\n${t:0:23}" "${execute[@]}")

  "${execute[@]}" &

  pid=$!
  pidFile="$stateDir/pid"
  echo "$pid" >"$pidFile"
  echo "PID $pid"

  terminate() {
    echo
    echo "ShutDown JS7 Agent Server"
    # Add some seconds to start Java with AgentClientMain
    terminateTimeout=30
    if [ "$SHELL" = "/bin/bash" ]; then
      "$JOBSCHEDULER_HOME"/bin/js7-client --data-directory="$data" "$terminateCommand" &
    else
      "$java" -Xmx50m \
        -Dlog4j.configurationFile=js7/agent/client/main/log4j2.xml \
        -classpath "$classpathString" \
        js7.agent.client.main.AgentClientMain \
        --data-directory="$data" \
        http://127.0.0.1:"$httpPort" \
        "$terminateCommand" \
        >/dev/null &
    fi
    (sleep $terminateTimeout && kill $pid) &
    killer=$!
    wait $pid
    kill $killer
  }

  trap terminate SIGTERM SIGINT
  returnCode=0
  wait $pid || {
    returnCode=$?
    echo "JS7 Agent Server exited with exit code $returnCode"
  }
  rm "$pidFile"
  trap - SIGTERM SIGINT

  if [ -n "$crashKillScript" ] && [ -s "$crashKillScript" ]; then :
    ps fux || true
    echo "Executing crash kill script $crashKillScript:"
    cat "$crashKillScript"
    (. "$crashKillScript" || true)
    ps fux || true
  fi
  (t=$(date +"%Y-%m-%d %H:%M:%S.%N"); echo -e "\n${t:0:23} JS7 Agent Server has been shut down" >>"$logs/stdouterr.log")

  if [[ $returnCode -ne 97 ]] && [[ $returnCode -ne 98 ]]; then
    exit $returnCode
  fi
  echo
  echo "Starting again"
done
