#!/usr/bin/env bash
set -e

dev="$JOBSCHEDULER_DEV"
jobschedulerTgz=
jobschedulerDockerTgz=

for arg in "$@"; do :
  case "$arg" in
    -dev=*)
      dev="${arg#*=}"
      if [ -f "$dev/jobscheduler/build.sbt" ]; then
        dev="$dev/jobscheduler"
      fi
      shift
      ;;
    -jobscheduler.tgz=*)
      jobschedulerTgz="${arg#*=}"
      shift
      ;;
    -jobscheduler-docker.tgz=*)
      jobschedulerDockerTgz="${arg#*=}"
      shift
      ;;
    *)
      echo Invalid option: $arg
      exit 1
      ;;
  esac
done

if [ -z "$jobschedulerTgz" ]; then
  if [ -n "$dev" ]; then
    jobschedulerTgz="$(echo "$dev"/jobscheduler/target/universal/jobscheduler-[1-9]*.tgz)"
  else
    echo "Missing argument -jobscheduler.tgz= or -dev= (with jobscheduler development directory)"
    exit 1
  fi
fi
if [ -z "$jobschedulerDockerTgz" ]; then
  if [ -n "$dev" ]; then
    jobschedulerDockerTgz="$(echo "$dev"/jobscheduler/jobscheduler-docker/target/universal/jobscheduler-docker-[1-9]*.tgz)"
  else
    echo "Missing argument -jobschedulerDocker.tgz= or -dev= (with jobscheduler development directory)"
    exit 1
   fi
fi

cd "$(dirname -- "$0")"
if [ -d build ] && [ ! -f build/docker-compose.yml ]; then :
  echo Subdirectory build seems not to be created by jobscheduler-docker. Missing build/docker-compose.yml. Exiting
  exit 1
fi

rm -rf build
mkdir build
tar xzf "$jobschedulerDockerTgz" -C build
#chmod +x build/bin/{prepare-volumes,clean-volumes-data,testMasterAgent}
ln -nf "$jobschedulerTgz" build/ >/dev/null || cp "$jobschedulerTgz" build/

build/bin/prepare-volumes

[ -f docker-compose.yml ] || ln -sf build/docker-compose.yml .

docker-compose build
docker-compose down

echo
echo Start with: docker-compose up
