#!/usr/bin/env bash
set -e

dockerTgz="$(ls jobscheduler-docker-[0-9]*.tgz)"
installTgz=($(ls jobscheduler-*install-[0-9]*.tgz))

for arg in "$@"; do :
  case "$arg" in
    *)
      echo "Invalid option: $arg"
      exit 1
      ;;
  esac
done

if [ -d build ] && [ ! -f build/bin/prepare ]; then :
  echo "Subdirectory build seems not to be created by jobscheduler-docker. Missing file build/bin/prepare. Exiting"
  exit 1
fi

rm -rf build
tar xzf "$dockerTgz"
cp "${installTgz[@]}" build/
build/bin/prepare-volumes

[ -f docker-compose.yml ] || ln -sf build/docker-compose.yml .

docker-compose down
docker-compose rm -v
# Let Docker not accumulate old images:
docker rmi jobscheduler &>/dev/null || true
docker-compose build --parallel
docker-compose up --no-start

echo
echo Start with: docker-compose start
