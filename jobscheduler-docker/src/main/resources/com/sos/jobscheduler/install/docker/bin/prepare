#!/usr/bin/env bash
set -e

installTgz=jobscheduler-*install-[0-9]*.tgz

for arg in "$@"; do :
  case "$arg" in
    *)
      echo "Invalid option: $arg"
      exit 1
      ;;
  esac
done

if [ -d build ] && [ ! -f build/bin/prepare ]; then :
  echo "Subdirectory build seems not to be created by jobscheduler-docker. Missing file build/bin/prepare. Exiting"
  exit 1
fi
dockerTgz="jobscheduler-docker-[0-9]*.tgz"
ls $dockerTgz >/dev/null || {
  echo "Missing file '$dockerTgz'"
  exit 1
}
installTgz="jobscheduler-*install-[0-9]*.tgz"
ls $installTgz >/dev/null || {
  echo "Missing file '$installTgz'"
  exit 1
}

rm -rf build
tar xzf jobscheduler-docker-[0-9]*.tgz
cp jobscheduler-*install-[0-9]*.tgz build/
build/bin/prepare-volumes

[ -f docker-compose.yml ] || ln -sf build/docker-compose.yml .

docker-compose down
# Let Docker not accumulate old images:
docker-compose rm -v
docker-compose build

echo
echo Start with: docker-compose up
