#!/usr/bin/env bash
set -e

cd "$(cd "$(realpath "${0%/*}")"/../../build/bin/../.. && pwd)"

homedir="$(pwd)/gnupg"
privateKeyFile=volumes/provider/config/private/private-pgp-key.asc
masterPublicKeyFile=volumes/master/config/private/trusted-pgp-keys/test.asc
agent1PublicKeyFile=volumes/agent-1/config/private/trusted-pgp-keys/test.asc
agent2PublicKeyFile=volumes/agent-2/config/private/trusted-pgp-keys/test.asc

mkdir -p volumes/master/config/private/trusted-pgp-keys
mkdir -p volumes/backup-master/config/private/trusted-pgp-keys
mkdir -p volumes/agent-1/config/private/trusted-pgp-keys
mkdir -p volumes/agent-2/config/private/trusted-pgp-keys

umask go-rwx

if [ -s "$privateKeyFile" ] && [ -s "$masterPublicKeyFile" ]; then
  echo "PGP files exist already. Nothing to do"
else
  which gpg >/dev/null || {
    echo "Missing gpg (GnuPG)"
    exit 1
  }
  if [ -d "$homedir" ]; then
    gpg --homedir "$homedir" --export-secret-keys --armor --output="$privateKeyFile"
    gpg --homedir "$homedir" --export --armor --output="$masterPublicKeyFile"
  fi
  if [ -s "$privateKeyFile" ] && [ -s "$masterPublicKeyFile" ]; then
    :
  else
    mkdir -p gnupg
    chmod go-rwx gnupg
    gpg-agent --homedir="$homedir" --quiet || gpg-agent --homedir="$homedir" --daemon  # How to terminate???
    gpg --homedir="$homedir" --gen-key --batch <<EOF
      Key-Type: DSA
      Key-Length: 1024
      Subkey-Type: ELG-E
      Subkey-Length: 1024
      Name-Real: JobScheduler Provider Demo
      Name-Comment: demonstration only
      Name-Email: jobscheduler@example.com
      Expire-Date: 0
      Passphrase: PGP-PASSWORD
EOF
    gpg --homedir "$homedir" --export-secret-keys --armor --output="$privateKeyFile"
    gpg --homedir "$homedir" --export --armor --output="$masterPublicKeyFile"
  fi
fi

for a in volumes/backup-master volumes/agent-*; do
  cp -p "$masterPublicKeyFile" "$a/config/private/trusted-pgp-keys/test.asc"
done
ls -ld "$privateKeyFile" volumes/*/config/private/trusted-pgp-keys/test.asc
