#!/usr/bin/env bash
set -euo pipefail

. /opt/js7/bin/internal/set-context.sh
declare JAVA_VERSION_MAJOR classpathString java # returned by set-context.sh
declare -a standardJavaOptions

data="$HOME/data"
agentPath=""

for arg in "$@"; do :
  case "$arg" in
    --agent=*)
      a="${arg#--agent=}"
      agentPath="$a"
      ;;
    *)
      echo Unknown argument: $arg
      exit 1
  esac
done

if [ -n "$agentPath" ]; then
  cmd="{ \"TYPE\": \"ClusterSwitchOver\", \"agentPath\": \"$agentPath\" }"
else
  cmd='{ "TYPE": "ClusterSwitchOver" }'
fi

if [ -f "config/controller.conf" ]; then
  exec /opt/js7/bin/js7-client --data-directory="$data" "$cmd"
else
  # js7-client does not work for ClusterSwitchOver.
  # SubagentClientMain sends the command to the Agent web service (not Subagent web service):
  cmdLine=()
  if [[ -f "$data/cache/js7.jsa" && "$JAVA_VERSION_MAJOR" -ge 19 ]]; then
    standardJavaOptions+=("-XX:SharedArchiveFile=$data/cache/js7.jsa")
  fi
  cmdLine=("$java" -Xmx50m "${standardJavaOptions[@]}" -classpath "$classpathString"
    js7.agent.client.main.SubagentClientMain --data-directory="$data" "$cmd")
  echo 1>&2 "${cmdLine[@]}"
  "${cmdLine[@]}"
fi
