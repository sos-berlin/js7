#!/usr/bin/env bash
set -e

export JOBSCHEDULER_HOME="$(cd "$(dirname -- "$0")/../bin/.." && pwd || kill $$)"
. "$JOBSCHEDULER_HOME/bin/internal/set-context.sh"
declare classpathString java

config=/var/opt/jobscheduler/master/config
data=/var/opt/jobscheduler/master/data
httpPort=4444
args=()
javaOptions=(-Xmx100m -Xms50m)

for arg in "$@"; do :
  case "$arg" in
    -java-option=*)
      a="${arg#*=}"
      javaOptions+=("$a")
      shift
      ;;
    -J*)
      a="${arg#-J}"
      javaOptions+=("$a")
      shift
      ;;
    -http-port=*)
      httpPort="${arg#*=}"
      shift
      ;;
    *)
      args+=("$arg")
      shift
      ;;
  esac
done

if [ ! -d "$config" ]; then :
  echo "No such directory: -config-directory=$config"
  exit 1
fi

if [ ! -d "$data" ]; then :
  echo "No such directory: -data-directory=$data"
  exit 1
fi

execute=(
  "$java"
  "${javaOptions[@]}"
  -classpath "$classpathString"
  -Dlog4j.configurationFile=com/sos/jobscheduler/master/client/main/log4j2.xml \
  com.sos.jobscheduler.master.client.main.MasterClientMain
  http://127.0.0.1:$httpPort
  "${args[@]}")
exec "${execute[@]}"
